#!/usr/bin/env bash

set -u

# PHP, Python, NodeJS, Java, Ruby

CONTAINERS=(
  "debian:buster-slim"
  "debian:stable-slim"
  "gcr.io/distroless/base-debian11"
  "gcr.io/distroless/java-debian11"
  "gcr.io/distroless/nodejs-debian11"
  "gcr.io/distroless/python3-debian11"
  "gcr.io/distroless/static"
  "gcr.io/distroless/static-debian11"
  "node:18-alpine"
  "node:latest"
  "node:slim"
  "openjdk:20-oracle"
  "openjdk:20-slim"
  "openjdk:latest"
  "php:latest"
  "python:alpine"
  "python:slim"
  "registry.access.redhat.com/ubi9-micro"
  "registry.access.redhat.com/ubi9-minimal"
  "registry.access.redhat.com/ubi9/nodejs-16"
  "registry.access.redhat.com/ubi9/nodejs-16-minimal"
  "registry.access.redhat.com/ubi9/openjdk-11-runtime"
  "registry.access.redhat.com/ubi9/php-80"
  "registry.access.redhat.com/ubi9/python-39"
  "registry.access.redhat.com/ubi9/ruby-30"
  "registry.access.redhat.com/ubi9/ubi"
  "ruby:alpine"
  "ruby:latest"
  "ruby:slim"
  "ubuntu:latest"
)

echo "*** $(date +%F)"
for CONTAINER in "${CONTAINERS[@]}"; do
  docker pull "${CONTAINER}" > /dev/null
  TRIVY_OUTPUT=$(trivy image --quiet "${CONTAINER}" | grep 'Total:.*CRITICAL: [1-9]')
  if [[ "${TRIVY_OUTPUT}" =~ .*CRITICAL.* ]]; then
    docker inspect --format '* {{ index .RepoTags 0 }} | {{ index .RepoDigests 0 }}' "${CONTAINER}"
    echo "${TRIVY_OUTPUT}"
    if [[ "${CONTAINER}" =~ .*registry.access.redhat.com.* ]]; then
      docker inspect --format 'Release: {{ index .Config.Labels "release"}} | Build date: {{ index .Config.Labels "build-date"}}{{ println }}' "${CONTAINER}"
    fi
  fi
done
